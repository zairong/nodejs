<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>用戶管理系統</title>
  <link rel="stylesheet" href="/stylesheets/style.css">
</head>

<body>
  <div class="container">
    <h1>用戶管理系統</h1>
    
    <!-- 用戶統計 -->
    <div class="stats-card">
      <h2>用戶統計</h2>
      <div class="stat-item">
        <span class="stat-label">總用戶數：</span>
        <span id="userCount" class="stat-value">載入中...</span>
      </div>
    </div>

    <!-- 新增用戶表單 -->
    <div class="form-card">
      <h2>新增用戶</h2>
      <form id="addUserForm">
        <div class="form-group">
          <label for="userName">姓名：</label>
          <input type="text" id="userName" name="name" required>
        </div>
        <div class="form-group">
          <label for="userEmail">電子郵件：</label>
          <input type="email" id="userEmail" name="email" required>
        </div>
        <button type="submit" class="btn btn-primary">新增用戶</button>
      </form>
    </div>

    <!-- 用戶列表 -->
    <div class="users-card">
      <div class="users-header">
        <h2>用戶列表</h2>
        <button id="refreshBtn" class="btn btn-secondary">重新整理</button>
      </div>
      <div id="usersTable">
        <div class="loading">載入用戶資料中...</div>
      </div>
    </div>

    <!-- 編輯用戶模態視窗 -->
    <div id="editModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>編輯用戶</h3>
          <span class="close">&times;</span>
        </div>
        <form id="editUserForm">
          <input type="hidden" id="editUserId">
          <div class="form-group">
            <label for="editUserName">姓名：</label>
            <input type="text" id="editUserName" name="name" required>
          </div>
          <div class="form-group">
            <label for="editUserEmail">電子郵件：</label>
            <input type="email" id="editUserEmail" name="email" required>
          </div>
          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" id="cancelEdit">取消</button>
            <button type="submit" class="btn btn-primary">儲存變更</button>
          </div>
        </form>
      </div>
    </div>

    <!-- 訊息顯示區 -->
    <div id="messageArea"></div>
  </div>

  <script>
    // 全域變數
    let users = [];
    const API_BASE = '/api';

    // DOM 元素
    const userCountEl = document.getElementById('userCount');
    const addUserForm = document.getElementById('addUserForm');
    const editUserForm = document.getElementById('editUserForm');
    const usersTableEl = document.getElementById('usersTable');
    const refreshBtn = document.getElementById('refreshBtn');
    const editModal = document.getElementById('editModal');
    const messageAreaEl = document.getElementById('messageArea');

    // 初始化
    document.addEventListener('DOMContentLoaded', function() {
      loadUsers();
      setupEventListeners();
    });

    // 設定事件監聽器
    function setupEventListeners() {
      // 新增用戶表單
      addUserForm.addEventListener('submit', handleAddUser);
      
      // 編輯用戶表單
      editUserForm.addEventListener('submit', handleEditUser);
      
      // 重新整理按鈕
      refreshBtn.addEventListener('click', loadUsers);
      
      // 模態視窗關閉
      document.querySelector('.close').addEventListener('click', closeEditModal);
      document.getElementById('cancelEdit').addEventListener('click', closeEditModal);
      
      // 點擊模態視窗外部關閉
      window.addEventListener('click', function(event) {
        if (event.target === editModal) {
          closeEditModal();
        }
      });
    }

    // 載入用戶資料
    async function loadUsers() {
      try {
        showMessage('載入用戶資料中...', 'info');
        const response = await fetch(`${API_BASE}/users`);
        
        if (response.ok) {
          const data = await response.json();
          users = data.users;
          updateUserCount(data.count);
          renderUsersTable();
          showMessage('用戶資料載入成功', 'success');
        } else {
          // 如果 API 失敗，使用模擬資料進行演示
          console.warn('API 連接失敗，使用模擬資料');
          users = [
            {
              id: 1,
              name: '張三',
              email: 'zhang@example.com',
              created_at: new Date().toISOString()
            },
            {
              id: 2,
              name: '李四',
              email: 'li@example.com',
              created_at: new Date(Date.now() - 86400000).toISOString()
            },
            {
              id: 3,
              name: '王五',
              email: 'wang@example.com',
              created_at: new Date(Date.now() - 172800000).toISOString()
            }
          ];
          updateUserCount(users.length);
          renderUsersTable();
          showMessage('載入演示資料成功（API 離線模式）', 'info');
        }
      } catch (error) {
        console.error('載入用戶錯誤:', error);
        // 使用模擬資料作為備用
        users = [
          {
            id: 1,
            name: '張三',
            email: 'zhang@example.com',
            created_at: new Date().toISOString()
          },
          {
            id: 2,
            name: '李四',
            email: 'li@example.com',
            created_at: new Date(Date.now() - 86400000).toISOString()
          },
          {
            id: 3,
            name: '王五',
            email: 'wang@example.com',
            created_at: new Date(Date.now() - 172800000).toISOString()
          }
        ];
        updateUserCount(users.length);
        renderUsersTable();
        showMessage('使用演示資料（離線模式）', 'info');
      }
    }

    // 更新用戶數量顯示
    function updateUserCount(count) {
      userCountEl.textContent = count;
    }

    // 渲染用戶表格
    function renderUsersTable() {
      if (users.length === 0) {
        usersTableEl.innerHTML = '<div class="no-data">目前沒有用戶資料</div>';
        return;
      }

      const tableHTML = `
        <table class="users-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>姓名</th>
              <th>電子郵件</th>
              <th>創建時間</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody>
            ${users.map(user => `
              <tr>
                <td>${user.id}</td>
                <td>${user.name}</td>
                <td>${user.email}</td>
                <td>${formatDate(user.created_at)}</td>
                <td class="actions">
                  <button class="btn btn-sm btn-edit" onclick="openEditModal(${user.id})">編輯</button>
                  <button class="btn btn-sm btn-delete" onclick="deleteUser(${user.id})">刪除</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
      
      usersTableEl.innerHTML = tableHTML;
    }

    // 處理新增用戶
    async function handleAddUser(event) {
      event.preventDefault();
      
      const formData = new FormData(addUserForm);
      const userData = {
        name: formData.get('name'),
        email: formData.get('email')
      };

      try {
        const response = await fetch(`${API_BASE}/users`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(userData)
        });

        if (response.ok) {
          const data = await response.json();
          showMessage('用戶新增成功', 'success');
          addUserForm.reset();
          loadUsers();
        } else {
          throw new Error('API 連接失敗');
        }
      } catch (error) {
        console.error('新增用戶錯誤:', error);
        // 離線模式：添加到本地陣列
        const newUser = {
          id: Math.max(...users.map(u => u.id), 0) + 1,
          name: userData.name,
          email: userData.email,
          created_at: new Date().toISOString()
        };
        users.unshift(newUser);
        updateUserCount(users.length);
        renderUsersTable();
        addUserForm.reset();
        showMessage('用戶新增成功（離線模式）', 'success');
      }
    }

    // 開啟編輯模態視窗
    function openEditModal(userId) {
      const user = users.find(u => u.id === userId);
      if (user) {
        document.getElementById('editUserId').value = user.id;
        document.getElementById('editUserName').value = user.name;
        document.getElementById('editUserEmail').value = user.email;
        editModal.style.display = 'block';
      }
    }

    // 關閉編輯模態視窗
    function closeEditModal() {
      editModal.style.display = 'none';
      editUserForm.reset();
    }

    // 處理編輯用戶
    async function handleEditUser(event) {
      event.preventDefault();
      
      const userId = parseInt(document.getElementById('editUserId').value);
      const formData = new FormData(editUserForm);
      const userData = {
        name: formData.get('name'),
        email: formData.get('email')
      };

      try {
        const response = await fetch(`${API_BASE}/users/${userId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(userData)
        });

        if (response.ok) {
          const data = await response.json();
          showMessage('用戶更新成功', 'success');
          closeEditModal();
          loadUsers();
        } else {
          throw new Error('API 連接失敗');
        }
      } catch (error) {
        console.error('更新用戶錯誤:', error);
        // 離線模式：更新本地陣列
        const userIndex = users.findIndex(u => u.id === userId);
        if (userIndex !== -1) {
          users[userIndex] = {
            ...users[userIndex],
            name: userData.name,
            email: userData.email,
            updated_at: new Date().toISOString()
          };
          renderUsersTable();
          closeEditModal();
          showMessage('用戶更新成功（離線模式）', 'success');
        } else {
          showMessage('找不到要更新的用戶', 'error');
        }
      }
    }

    // 刪除用戶
    async function deleteUser(userId) {
      if (!confirm('確定要刪除這個用戶嗎？')) {
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/users/${userId}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          const data = await response.json();
          showMessage('用戶刪除成功', 'success');
          loadUsers();
        } else {
          throw new Error('API 連接失敗');
        }
      } catch (error) {
        console.error('刪除用戶錯誤:', error);
        // 離線模式：從本地陣列中移除
        const userIndex = users.findIndex(u => u.id === parseInt(userId));
        if (userIndex !== -1) {
          users.splice(userIndex, 1);
          updateUserCount(users.length);
          renderUsersTable();
          showMessage('用戶刪除成功（離線模式）', 'success');
        } else {
          showMessage('找不到要刪除的用戶', 'error');
        }
      }
    }

    // 顯示訊息
    function showMessage(message, type = 'info') {
      const messageEl = document.createElement('div');
      messageEl.className = `message message-${type}`;
      messageEl.textContent = message;
      
      messageAreaEl.appendChild(messageEl);
      
      // 3秒後自動移除訊息
      setTimeout(() => {
        if (messageEl.parentNode) {
          messageEl.parentNode.removeChild(messageEl);
        }
      }, 3000);
    }

    // 格式化日期
    function formatDate(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      return date.toLocaleString('zh-TW');
    }
  </script>
</body>

</html>
